<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            display: flex;
            margin: 0;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            padding: 20px;
            background-color: #f4f4f4;
            border-right: 1px solid #ddd;
        }

        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .crop-group,
        .year-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        .crop-group button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            background-color: #fff;
            cursor: pointer;
        }

        .crop-group button.selected {
            background-color: #ddd;
            border-color: #aaa;
        }

        .year-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .year-group label {
            margin-bottom: 10px;
        }

        .year-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .year-controls button {
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #fff;
            cursor: pointer;
        }

        .year-display {
            padding: 10px;
            font-size: 18px;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="crop-group">
            <label>작물 선택</label>
            <button id="potato" onclick="selectCrop('potato')">감자</button>
            <button id="swpotato" onclick="selectCrop('swpotato')">고구마</button>
            <button id="papper" onclick="selectCrop('papper')">고추</button>
            <button id="leek" onclick="selectCrop('leek')">대파</button>
            <button id="rice" onclick="selectCrop('rice')">벼</button>
            <button id="peach" onclick="selectCrop('peach')">복숭아</button>
            <button id="apple" onclick="selectCrop('apple')">사과</button>
            <button id="onion" onclick="selectCrop('onion')">양파</button>
            <button id="corn" onclick="selectCrop('corn')">옥수수</button>
            <button id="soybean" onclick="selectCrop('soybean')">콩</button>
            <button id="grape" onclick="selectCrop('grape')">포도</button>
        </div>
        <div class="year-group">
            <label>연도 선택</label>
            <div class="year-controls">
                <button onclick="changeYear(-1)">&#9664;</button>
                <div class="year-display" id="year-display">2025</div>
                <button onclick="changeYear(1)">&#9654;</button>
            </div>
        </div>
    </div>
    <div class="main-content" id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        let currentYear = 2025;
        const minYear = 2025;
        const maxYear = 2055;
        const yearDisplay = document.getElementById('year-display');
        document.getElementById('rice').classList.add('selected'); // 초기 상태로 쌀 버튼 선택
        let selectedCrop = '벼'
        var geojsonURL = 'https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2013/json/skorea_provinces_geo_simple.json';

        /*********************
        * 연도, 작물 선택 창  *
        **********************/
        function selectCrop(cropId) {
            selectedCrop = document.getElementById(cropId).innerText;
            changeYear(minYear-currentYear);

            const buttons = document.querySelectorAll('.crop-group button');
            buttons.forEach(button => {
                if (button.id === cropId) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });
        }

        function changeYear(direction) {
            const newYear = currentYear + direction;
            if (newYear >= minYear && newYear <= maxYear) {
                currentYear = newYear;
                yearDisplay.textContent = currentYear;
            }

            sendData({ crop: selectedCrop, year: currentYear });
        }

        function sendData(data) {
            console.log('Sending data:', data);

            fetch('/select_crop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                setMap(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        /*********************
        *      지도 표시      *
        **********************/
        var map = L.map('map').setView([37.5642135, 127.0016985], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map);
        var geojsonLayer = null;
        sendData({ crop: selectedCrop, year: currentYear});

        function setMap(regionProductionData){
            //이전 레이어 지우기
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }

            let sortedRegions = Object.entries(regionProductionData).sort((a, b) => b[1].prediction - a[1].prediction);
            let rankMap = {};
            sortedRegions.forEach((region, index) => {
                rankMap[region[1].region] = index + 1; // 인덱스는 0부터 시작하므로 +1 해줌
            });

            function calculateColor(region) {
                if(region == '제주특별자치도') region = '제주도'
                let rank = rankMap[region];
                let totalRegions = sortedRegions.length;
                let scaledValue = rank / totalRegions;

                // 예시: 하얀색(255, 255, 255)에서 초록색(0, 255, 0)으로 변화하는 컬러 맵 사용
                let green = Math.round(255 * (1 - scaledValue)); // 적게 생산할수록 빨간색이 많아짐
                let red = 255; // 녹색은 항상 최대
                let blue = Math.round(255 * (1 - scaledValue)); // 적게 생산할수록 파란색이 많아짐
                return `rgb(${red}, ${green}, ${blue})`;
            }

            fetch(geojsonURL)
                .then(response => response.json())
                .then(data => {
                    geojsonLayer = L.geoJSON(data, {
                        style: function (feature) {
                            return {
                                fillColor: calculateColor(feature.properties.name),
                                weight: 1,
                                opacity: 1,
                                color: 'white',
                                dashArray: '3',
                                fillOpacity: 0.9
                            };
                        },
                        onEachFeature: function (feature, layer) {
                            // 마우스 이벤트를 이용한 스타일 변경
                            layer.on({
                                mouseover: function () {
                                    layer.setStyle({
                                        weight: 2,
                                        color: '#666',
                                        dashArray: '',
                                        fillOpacity: 0.2
                                    });
                                },
                                mouseout: function () {
                                    layer.setStyle({
                                        fillColor: calculateColor(feature.properties.name),
                                        weight: 1,
                                        color: 'white',
                                        dashArray: '3',
                                        fillOpacity: 0.9
                                    });
                                }
                            });
                        }
                    }).addTo(map);

                });
        }

        /*********************
        *    지도 공시지가    *
        **********************/
        map.on('click', function (e) {
            var latlng = e.latlng;
            var latitude = latlng.lat;
            var longitude = latlng.lng;

            // mapPrice.html을 위한 URL 생성
            const mapPriceUrl = '/mapPrice/?lat=' + latitude + '&lng=' + longitude;

            // 새 창으로 mapPrice.html 열기 (팝업 창으로 열기)
            var popupWindow = window.open(mapPriceUrl, 'MapPricePopup', 'width=600,height=400');
            if (popupWindow) {
                popupWindow.focus();
            } else {
                alert('팝업 창이 차단되었습니다. 팝업 차단을 해제하고 다시 시도해주세요.');
            }
        });
    </script>
</body>

</html>